{%- comment -%}
  Derive a human-friendly title for a Jekyll page.

  Priority:
  1) Front matter `title`
  2) First Markdown heading in the page content (e.g. "# Title", "## Title")
  3) Fallback from filename (strip numeric ordering prefix like "2 Foo.md" -> "Foo")

  Special cases:
  - README.md: fall back to site.title instead of "README"
  - Index.md / 0 Index.md: fall back to the directory name instead of "Index"

  Usage:
    {% capture t %}{% include title_from_heading.html page=some_page %}{% endcapture %}
    {% assign t = t | strip %}
{%- endcomment -%}

{%- assign p = include.page -%}

{%- if p and p.title and p.title != "" -%}
  {{- p.title -}}
{%- else -%}
  {%- assign derived_heading_line = "" -%}

  {%- if p and p.content and p.content != "" -%}
    {%- assign lines = p.content | split: "\n" -%}
    {%- for line in lines -%}
      {%- assign s = line | strip -%}
      {%- if s != "" -%}
        {%- assign first_char = s | slice: 0, 1 -%}
        {%- if first_char == "#" -%}
          {%- assign derived_heading_line = s -%}
          {%- break -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}

  {%- if derived_heading_line != "" -%}
    {%- assign t = derived_heading_line | strip -%}
    {%- assign t = t
      | remove_first: "###### "
      | remove_first: "##### "
      | remove_first: "#### "
      | remove_first: "### "
      | remove_first: "## "
      | remove_first: "# "
      | remove_first: "######"
      | remove_first: "#####"
      | remove_first: "####"
      | remove_first: "###"
      | remove_first: "##"
      | remove_first: "#"
      | strip -%}
    {{- t -}}
  {%- else -%}
    {%- assign filename = "" -%}
    {%- if p and p.path and p.path != "" -%}
      {%- assign filename = p.path | split: "/" | last -%}
    {%- endif -%}

    {%- if filename == "README.md" -%}
      {{- site.title | default: "Home" -}}
    {%- elsif filename == "0 Index.md" or filename == "Index.md" -%}
      {%- if p.path contains "/" -%}
        {%- assign dir = p.path | split: "/" | first -%}
        {%- assign dir_parts = dir | split: " " -%}
        {%- assign dir_first = dir_parts | first -%}
        {%- assign dir_first_as_num_str = dir_first | plus: 0 | append: "" -%}
        {%- if dir_parts.size > 1 and dir_first == dir_first_as_num_str -%}
          {%- assign dir = dir | remove_first: dir_first | remove_first: " " -%}
        {%- endif -%}
        {{- dir -}}
      {%- else -%}
        {{- site.title | default: "Index" -}}
      {%- endif -%}
    {%- else -%}
      {%- assign base_name = filename | split: "." | first -%}
      {%- assign parts = base_name | split: " " -%}
      {%- assign first = parts | first -%}
      {%- assign first_as_num_str = first | plus: 0 | append: "" -%}
      {%- assign display = base_name -%}
      {%- if parts.size > 1 and first == first_as_num_str -%}
        {%- assign display = base_name | remove_first: first | remove_first: " " -%}
      {%- endif -%}
      {{- display -}}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}
